name: oauth2_llavemx
version: 3.2.1

patches:

  ##############################################
  # SETTINGS PARA LMS
  ##############################################
  openedx-lms-common-settings: |
    # Registrar backend
    AUTHENTICATION_BACKENDS = list(AUTHENTICATION_BACKENDS)
    LLAVEMX_BACKEND = "oauth2_llavemx.llavemx_oauth.LlaveMXOAuth2"
    if LLAVEMX_BACKEND not in AUTHENTICATION_BACKENDS:
        AUTHENTICATION_BACKENDS.insert(0, LLAVEMX_BACKEND)

    # Registrar en third_party_auth SOLO LMS
    THIRD_PARTY_AUTH_BACKENDS = list(globals().get("THIRD_PARTY_AUTH_BACKENDS", []))
    if LLAVEMX_BACKEND not in THIRD_PARTY_AUTH_BACKENDS:
        THIRD_PARTY_AUTH_BACKENDS.append(LLAVEMX_BACKEND)

    # Credenciales
    SOCIAL_AUTH_LLAVEMX_WS_USER = os.environ.get("LLAVEMX_WS_USER", "")
    SOCIAL_AUTH_LLAVEMX_WS_PASSWORD = os.environ.get("LLAVEMX_WS_PASSWORD", "")

    # CORS / CSRF para LMS
    CORS_ORIGIN_WHITELIST = list(CORS_ORIGIN_WHITELIST)
    CORS_ORIGIN_WHITELIST.extend([
        "https://val-llavemx.infotec.mx",
        "https://val-api-llavemx.infotec.mx",
        "https://llavemx.gob.mx",
        "https://api-llavemx.gob.mx",
    ])

    CSRF_TRUSTED_ORIGINS = list(CSRF_TRUSTED_ORIGINS)
    CSRF_TRUSTED_ORIGINS.extend([
        "https://val-llavemx.infotec.mx",
        "https://val-api-llavemx.infotec.mx",
        "https://llavemx.gob.mx",
        "https://api-llavemx.gob.mx",
    ])

    LOGIN_REDIRECT_WHITELIST = list(LOGIN_REDIRECT_WHITELIST)
    LOGIN_REDIRECT_WHITELIST.extend([
        "val-llavemx.infotec.mx",
        "val-api-llavemx.infotec.mx",
        "llavemx.gob.mx",
        "api-llavemx.gob.mx",
    ])

    # Registrar la app de backend SOLO en LMS
    INSTALLED_APPS.append("oauth2_llavemx.apps.OAuth2LlaveMXConfig")


  ##############################################
  # SETTINGS PARA CMS (Studio)
  ##############################################
  openedx-cms-common-settings: |
    # NO registrar backend
    # NO agregar THIRD_PARTY_AUTH_BACKENDS
    # Solo CORS si lo necesitas
    CORS_ORIGIN_WHITELIST = list(CORS_ORIGIN_WHITELIST)
    CORS_ORIGIN_WHITELIST.extend([
        "https://val-llavemx.infotec.mx",
    ])

    CSRF_TRUSTED_ORIGINS = list(CSRF_TRUSTED_ORIGINS)
    CSRF_TRUSTED_ORIGINS.extend([
        "https://val-llavemx.infotec.mx",
    ])